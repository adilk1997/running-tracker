<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Runs</title>
  <link rel="stylesheet" href="/styles.css" />
</head>

<body>
    <form action="/auth/log-out" method="GET">
      <button class="btn btn-danger" type="submit">Log out</button>
    </form>
  
    <h1>Your Runs</h1>

  <a href="/runs/new">Add a new run</a>

  </header>

  <% if (runs.length === 0) { %>
    <p>No runs yet.</p>
  <% } else { %>

    <%

    let totalDistance = 0;
      let totalTime = 0;

      runs.forEach((run) => {
        totalDistance += Number(run.distance) || 0;
        totalTime += Number(run.time) || 0;
      });

      const totalHours = Math.floor(totalTime / 60);
      const totalMinutes = totalTime % 60;
      const totalMinutesPadded = totalMinutes < 10 ? ('0' + totalMinutes) : totalMinutes;
    %>

    <p>
      <strong>Total distance:</strong> <%= totalDistance %> km<br />
      <strong>Total time:</strong> <%= totalHours %>:<%= totalMinutesPadded %> (hh:mm)
    </p>

    <ul>
      <% runs.forEach((run) => { %>
        <%

        const dateStr = run.date ? run.date.toLocaleDateString('en-GB') : '';

          let paceMin = 0;
          let paceSec = 0;

          const distanceNum = Number(run.distance);
          const timeNum = Number(run.time);

          if (distanceNum > 0 && !Number.isNaN(distanceNum) && !Number.isNaN(timeNum)) {
            const pace = timeNum / distanceNum; // minutes per km (decimal)
            paceMin = Math.floor(pace);
            paceSec = Math.round((pace - paceMin) * 60);


            if (paceSec === 60) {
              paceMin += 1;
              paceSec = 0;
            }
          }

          const paceSecPadded = paceSec < 10 ? ('0' + paceSec) : paceSec;

          let avgSpeed = 0;

            if (distanceNum > 0 && timeNum > 0 && !Number.isNaN(distanceNum) && !Number.isNaN(timeNum)) {
            avgSpeed = (distanceNum / (timeNum / 60)).toFixed(1);
        }

        %>

        <li>
          <strong><%= dateStr %></strong> â€”
    <div style="display:inline-flex; gap:20px; align-items:flex-end;">

    <div style="text-align:center;">
     <small>Distance</small><br>
     <strong><%= run.distance %> km</strong>
    </div>

     <div style="text-align:center;">
     <small>Minutes</small><br>
     <strong><%= run.time %> min</strong>
    </div>

    <div style="text-align:center;">
     <small>Avg pace</small><br>
        <strong><%= paceMin %>:<%= paceSecPadded %> min/km</strong>
     </div>

    <div style="text-align:center;">
     <small>Avg speed</small><br>
        <strong><%= avgSpeed %> km/h</strong>
    </div>

    </div>


          <form action="/runs/<%= run._id %>/edit" method="GET" style="display:inline;">
            <button type="submit">Edit</button>
          </form>


          <form action="/runs/<%= run._id %>?_method=DELETE" method="POST" style="display:inline;">
            <button type="submit">Delete</button>
          </form>
        </li>
      <% }) %>
    </ul>

  <% } %>
</body>
</html>
