<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Runs</title>
</head>

<body>
  <h1>Your Runs</h1>

  <a href="/runs/new">Add a new run</a>

  <% if (runs.length === 0) { %>
    <p>No runs yet.</p>
  <% } else { %>

    <%
      // Totals
      let totalDistance = 0;
      let totalTime = 0;

      runs.forEach((run) => {
        totalDistance += Number(run.distance) || 0;
        totalTime += Number(run.time) || 0;
      });

      // Total time in hh:mm
      const totalHours = Math.floor(totalTime / 60);
      const totalMinutes = totalTime % 60;
      const totalMinutesPadded = totalMinutes < 10 ? ('0' + totalMinutes) : totalMinutes;
    %>

    <p>
      <strong>Total distance:</strong> <%= totalDistance %> km<br />
      <strong>Total time:</strong> <%= totalHours %>:<%= totalMinutesPadded %> (hh:mm)
    </p>

    <ul>
      <% runs.forEach((run) => { %>
        <%
          // Date
          const dateStr = run.date ? run.date.toLocaleDateString('en-GB') : '';

          // Pace (min/km) in mm:ss
          let paceMin = 0;
          let paceSec = 0;

          const distanceNum = Number(run.distance);
          const timeNum = Number(run.time);

          if (distanceNum > 0 && !Number.isNaN(distanceNum) && !Number.isNaN(timeNum)) {
            const pace = timeNum / distanceNum; // minutes per km (decimal)
            paceMin = Math.floor(pace);
            paceSec = Math.round((pace - paceMin) * 60);

            // handle rounding to 60 seconds
            if (paceSec === 60) {
              paceMin += 1;
              paceSec = 0;
            }
          }

          const paceSecPadded = paceSec < 10 ? ('0' + paceSec) : paceSec;
        %>

        <li>
          <strong><%= dateStr %></strong> —
          <%= run.distance %> km —
          <%= run.time %> min —
          <strong><%= paceMin %>:<%= paceSecPadded %> min/km</strong>

          <a href="/runs/<%= run._id %>/edit">Edit</a>

          <form action="/runs/<%= run._id %>?_method=DELETE" method="POST" style="display:inline;">
            <button type="submit">Delete</button>
          </form>
        </li>
      <% }) %>
    </ul>

  <% } %>
</body>
</html>
